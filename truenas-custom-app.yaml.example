# DockJob Custom App for TrueNAS
# Logo: https://raw.githubusercontent.com/matepalocska/dockjob/main/catalog/dockjob-logo.png
# Description: Job scheduler and executor with web interface
#
# CONFIGURATION GUIDE:
# 1. Replace YOUR_USERNAME with your Docker Hub username
# 2. Replace YOUR_TRUENAS_HOST with your TrueNAS hostname/IP
# 3. Replace YOUR_PORT with your desired external port (e.g., 30555)
# 4. Replace YOUR_SECURE_PASSWORD with a strong password
# 5. Replace YOUR_APP_NAME with your custom app name in TrueNAS
# 6. Ensure the volume paths match your TrueNAS app configuration

services:
  dockjob:
    container_name: dockjob
    # user: "568:568"  # Commented out - running as root for JobExecutor compatibility
    environment:
      - APIAPP_APIURL=http://YOUR_TRUENAS_HOST:PORT/api
      - >-
        APIAPP_TRIGGERAPIURL=http://YOUR_TRUENAS_HOST:PORT/triggerapi
      - APIAPP_APIDOCSURL=http://YOUR_TRUENAS_HOST:PORT/apidocs
      - APIAPP_FRONTENDURL=http://YOUR_TRUENAS_HOST:PORT/frontend
      - >-
        APIAPP_COMMON_ACCESSCONTROLALLOWORIGIN=http://YOUR_TRUENAS_HOST:PORT
      - DOCKJOB_EXTERNAL_TRIGGER_SYS_PASSWORD=YOUR_SECURE_PASSWORD
      - APIAPP_USERFORJOBS=apps
      - APIAPP_GROUPFORJOBS=apps
      - >-
        APIAPP_OBJECTSTORECONFIG={"Type":"SimpleFileStore", "BaseLocation":
        "/data"}
    # Ensure proper permissions for mounted volumes
    command: >
      sh -c "
      chown -R 568:568 /data /scripts /config 2>/dev/null || true;
      chmod -R 755 /data /scripts /config 2>/dev/null || true;
      exec /run_app_docker.sh
      "
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 5s
      test:
        - CMD
        - /healthcheck.sh
      timeout: 3s
    image: YOUR_USERNAME/dockjob:latest
    ports:
      - 'YOUR_PORT:80'
    restart: unless-stopped
    volumes:
      - /mnt/.ix-apps/app_configs/YOUR_APP_NAME:/config:rw
      - /mnt/.ix-apps/app_mounts/YOUR_APP_NAME/scripts:/scripts:rw
      - /mnt/.ix-apps/app_mounts/YOUR_APP_NAME/data:/data:rw
version: '3.8'
